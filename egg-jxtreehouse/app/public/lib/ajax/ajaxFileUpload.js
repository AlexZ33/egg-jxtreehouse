jQuery.extend({ createUploadIframe: function (a, b) { var d, c = "jUploadFrame" + a; return window.ActiveXObject ? "9.0" == jQuery.browser.version || "10.0" == jQuery.browser.version ? (d = document.createElement("iframe"), d.id = c, d.name = c) : ("6.0" == jQuery.browser.version || "7.0" == jQuery.browser.version || "8.0" == jQuery.browser.version) && (d = document.createElement('<iframe id="' + c + '" name="' + c + '" />'), "boolean" == typeof b ? d.src = "javascript:false" : "string" == typeof b && (d.src = b)) : (d = document.createElement("iframe"), d.id = c, d.name = c), d.style.position = "absolute", d.style.top = "-1000px", d.style.left = "-1000px", document.body.appendChild(d), d }, createUploadForm: function (a, b, c) { function k(a) { for (var b in a) b.indexOf("_nosign") > -1 && $("<input name='" + b.split("_nosign")[0] + "' id='" + b.split("_nosign")[0] + "' value='" + a[b] + "' />").appendTo(f), $("<input name='" + b + "' id='" + b + "' value='" + a[b] + "' />").appendTo(f), "object" == typeof a[b] && k(a[b]) } var h, i, j, d = "jUploadForm" + a, e = "jUploadFile" + a, f = $('<form  action="" method="POST" name="' + d + '" id="' + d + '" enctype="multipart/form-data"></form>'), g = b.length; for (h = 0; g > h; h++)i = $("#" + b[h]), j = $(i).clone(), $(i).attr("id", e), $(i).before(j), $(i).appendTo(f); return c && k(c), $(f).css("position", "absolute"), $(f).css("top", "-1200px"), $(f).css("left", "-1200px"), $(f).appendTo("body"), f }, ajaxFileUpload: function (a) { var b, c, d, e, g, h, j, k, l, m, n, o; if (a = jQuery.extend({ fileFilter: "", fileSize: 0 }, jQuery.ajaxSettings, a), b = $("#" + a.fileElementId).val(), c = b.substring(b.lastIndexOf(".") + 1).toLowerCase(), a.fileFilter && a.fileFilter.indexOf(c) < 0) return alert("仅支持 (" + a.fileFilter + ") 为后缀名的文件!"), void 0; if (a.fileSize > 0) { d = 0; try { window.ActiveXObject ? (e = new Image, e.dynsrc = b, d = e.fileSize) : d = $("#" + a.fileElementId)[0].files[0].size } catch (f) { } if (d > a.fileSize) return alert("当前文件大小 (" + d + ") 超过允许的限制值 (" + a.fileSize + ")！"), void 0 } g = (new Date).getTime(), h = jQuery.createUploadForm(g, a.fileElementId, a.data), jQuery.createUploadIframe(g, a.secureuri), j = "jUploadFrame" + g, k = "jUploadForm" + g, a.global && !jQuery.active++ && jQuery.event.trigger("ajaxStart"), l = !1, m = {}, a.global && jQuery.event.trigger("ajaxSend", [m, a]), n = function (b) { var e, f, g, c = document.getElementById(j); try { c.contentWindow ? (m.responseText = c.contentWindow.document.body ? c.contentWindow.document.body.innerHTML : null, m.responseXML = c.contentWindow.document.XMLDocument ? c.contentWindow.document.XMLDocument : c.contentWindow.document) : c.contentDocument && (m.responseText = c.contentDocument.document.body ? c.contentDocument.document.body.innerHTML : null, m.responseXML = c.contentDocument.document.XMLDocument ? c.contentDocument.document.XMLDocument : c.contentDocument.document) } catch (d) { jQuery.handleErrorExt(a, m, null, d) } if (m || "timeout" == b) { l = !0; try { e = "timeout" != b ? "success" : "error", "error" != e ? (f = jQuery.uploadHttpData(m, a.dataType), a.success && ("token不存在" == f.message ? (g = { userid: jQuery.cookie("userid"), token: param.token }, $MT.ajax(get, g, function (b) { b.result ? (jQuery.cookie("token", b.token), $.ajaxFileUpload({ fileElementId: a.fileElementId, url: a.url, dataType: "json", data: a.data, success: function (b) { a.success(b, e) }, error: function () { }, complete: function () { } })) : window.location.href = localStorage.getItem("login") }, null, null, "POST")) : a.success(f, e)), a.global && jQuery.event.trigger("ajaxSuccess", [m, a])) : jQuery.handleErrorExt(a, m, e) } catch (d) { e = "error", jQuery.handleErrorExt(a, m, e, d) } a.global && jQuery.event.trigger("ajaxComplete", [m, a]), a.global && !--jQuery.active && jQuery.event.trigger("ajaxStop"), a.complete && a.complete(m, e), jQuery(c).unbind(), setTimeout(function () { try { $(c).remove(), $(h).remove() } catch (b) { jQuery.handleErrorExt(a, m, null, b) } }, 100), m = null } }, a.timeout > 0 && setTimeout(function () { l || n("timeout") }, a.timeout); try { h = $("#" + k), $(h).attr("action", a.url), $(h).attr("method", "POST"), $(h).attr("target", j), h.encoding ? h.encoding = "multipart/form-data" : h.enctype = "multipart/form-data", o = $MT.paramSign(a.url.split("action=")[1], a.data), $(h).ajaxSubmit({ headers: { token: jQuery.cookie("token"), sign: o }, success: a.success }) } catch (f) { jQuery.handleErrorExt(a, m, null, f) } return window.attachEvent ? document.getElementById(j).attachEvent("onload", n) : document.getElementById(j).addEventListener("load", n, !1), { abort: function () { } } }, uploadHttpData: function (r, type) { var start, end, data = !type; return data = "xml" == type || data ? r.responseXML : r.responseText, "script" == type && jQuery.globalEval(data), "json" == type && (start = data.indexOf("{"), end = data.indexOf("}"), data = data.substring(start, end + 1), eval("data = " + data)), "html" == type && jQuery("<div>").html(data).evalScripts(), data }, handleErrorExt: function (a, b, c, d) { a.error && a.error.call(a.context || a, b, c, d), a.global && (a.context ? jQuery(a.context) : jQuery.event).trigger("ajaxError", [b, a, d]) } });